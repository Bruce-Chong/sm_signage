<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Slides → Two Videos (Reliable Loop)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    html, body { margin:0; height:100%; background:#000; }
    .stage { position:fixed; inset:0; display:grid; place-items:center; background:#000; }
    .hidden { display:none; }
    iframe, video { width:100vw; height:100vh; border:0; object-fit:cover; background:#000; }
  </style>
</head>
<body>
  <!-- Stage 1: Slides -->
  <div id="slidesStage" class="stage">
    <iframe
      id="slidesFrame"
      src="https://docs.google.com/presentation/d/e/2PACX-1vRZVITow9z28ok6mLfy0WHQkMjB7OTUOkkxbHslHLETin6UgO8g8sAmqymW3OJwLN5S59PrSB_PX-Ew/pubembed?start=false&loop=false&delayms=10000"
      allowfullscreen
    ></iframe>
  </div>

  <!-- Stage 2: Video(s) -->
  <div id="videoStage" class="stage hidden">
    <!-- We’ll set .src in JS so we can step through a playlist -->
    <video id="promoVideo" playsinline muted preload="auto"></video>
  </div>

  <script>
    // ====== CONFIG ======
    const SLIDESHOW_DURATION_MS = 50 * 1000; // 5 slides × 10s each
    const VIDEO_PLAYLIST = [
      "assets/fishesSM.mp4",
      "assets/petridish.mp4"
    ];
    // ====================

    const slidesStage = document.getElementById('slidesStage');
    const videoStage  = document.getElementById('videoStage');
    const videoEl     = document.getElementById('promoVideo');

    let slideTimer = null;
    let retryTimer = null;
    let playlistIndex = 0;
    let inVideoSequence = false;

    function clearTimers() {
      if (slideTimer) { clearTimeout(slideTimer); slideTimer = null; }
      if (retryTimer) { clearTimeout(retryTimer); retryTimer = null; }
    }

    function scheduleSlidesCountdown() {
      clearTimers();
      slideTimer = setTimeout(beginVideoSequence, SLIDESHOW_DURATION_MS);
    }

    function showSlides() {
      inVideoSequence = false;
      playlistIndex = 0;

      // Hide video, show slides
      videoStage.classList.add('hidden');
      slidesStage.classList.remove('hidden');

      // Stop & reset video so next play starts clean
      try {
        videoEl.pause();
        videoEl.removeAttribute('src'); // release decoder/buffers
        videoEl.load();
      } catch {}

      scheduleSlidesCountdown();
    }

    function tryPlayWithRetry(attempt = 1) {
      const p = videoEl.play();
      if (p && typeof p.then === 'function') {
        p.catch(() => {
          if (attempt < 5) {
            retryTimer = setTimeout(() => tryPlayWithRetry(attempt + 1), 700);
          } else {
            // Last resort: reload current src and try again
            const currentSrc = videoEl.currentSrc || videoEl.src;
            if (currentSrc) {
              videoEl.pause();
              videoEl.load();
            }
            retryTimer = setTimeout(() => tryPlayWithRetry(attempt + 1), 1000);
          }
        });
      }
    }

    function playVideoAt(index) {
      const src = VIDEO_PLAYLIST[index];
      if (!src) { return finishVideoSequence(); }

      // Always start from the beginning and ensure buffers are primed
      try {
        videoEl.pause();
        videoEl.currentTime = 0;
        videoEl.src = src;
        videoEl.load();
      } catch {}

      const startPlayback = () => tryPlayWithRetry();
      if (videoEl.readyState >= 3) {
        startPlayback();
      } else {
        const onCanPlay = () => {
          videoEl.removeEventListener('canplay', onCanPlay);
          startPlayback();
        };
        videoEl.addEventListener('canplay', onCanPlay, { once: true });
      }
    }

    function beginVideoSequence() {
      clearTimers();
      inVideoSequence = true;
      playlistIndex = 0;

      // Hide slides, show video
      slidesStage.classList.add('hidden');
      videoStage.classList.remove('hidden');

      playVideoAt(playlistIndex);
    }

    function finishVideoSequence() {
      showSlides();
    }

    // Handle the end of each video in the playlist
    videoEl.addEventListener('ended', () => {
      if (!inVideoSequence) return; // safety
      playlistIndex += 1;
      if (playlistIndex < VIDEO_PLAYLIST.length) {
        playVideoAt(playlistIndex);
      } else {
        finishVideoSequence();
      }
    });

    // Optional: if a video errors, skip to the next one (or back to slides)
    videoEl.addEventListener('error', () => {
      if (!inVideoSequence) return;
      playlistIndex += 1;
      if (playlistIndex < VIDEO_PLAYLIST.length) {
        playVideoAt(playlistIndex);
      } else {
        finishVideoSequence();
      }
    });

    // If user tabs away and comes back, resync timers/state
    document.addEventListener('visibilitychange', () => {
      if (!document.hidden) {
        if (slidesStage.classList.contains('hidden')) {
          // In video; ensure it’s playing or restart current item
          if (videoEl.paused || videoEl.ended) {
            if (inVideoSequence) {
              playVideoAt(playlistIndex);
            } else {
              beginVideoSequence();
            }
          }
        } else {
          // In slides; re-arm the countdown
          scheduleSlidesCountdown();
        }
      }
    });

    // Kick off the cycle with slides visible
    showSlides();
  </script>
</body>
</html>
